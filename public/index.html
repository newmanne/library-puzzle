<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Library of Babel</title>
  <style>
    :root{
      --fg:#222; --bg:#f6f2e9; --ink:#111; --muted:#6b6b6b; --accent:#7c5cff;
      --paper:#fffaf0; --rule:#d9d2c8; --serif:'Georgia', 'Iowan Old Style', 'Times New Roman', serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--fg); }
    body { background:
      repeating-linear-gradient( 180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.02) 12px, rgba(0,0,0,0.00) 12px, rgba(0,0,0,0.00) 24px),
      var(--bg);
    }
    header{ max-width:900px; margin:32px auto 16px; padding:0 18px; }
    h1{ font-family: var(--serif); font-weight:700; letter-spacing:0.5px; margin:4px 0 6px; }
    .subtitle{ color:var(--muted); font-style:italic; }
    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .controls input[type="number"], .controls input[type="text"]{ padding:8px 10px; border:1px solid var(--rule); border-radius:8px; font-size:16px; min-width:160px; }
    .controls button{ padding:9px 14px; border:1px solid var(--rule); background:#fff; border-radius:10px; cursor:pointer; font-weight:600; }
    .controls button:hover{ box-shadow:0 1px 0 rgba(0,0,0,0.08); }
    .controls .hint{ color:var(--muted); font-size:14px; }
    main{ max-width:900px; margin:18px auto 48px; padding:0 18px 24px; }
    .paper{ background:radial-gradient( 800px 300px at 50% -10%, #ffffff 0%, #fffaf4 60%, #f8f1e6 100% ); border:1px solid var(--rule); border-radius:14px; padding:28px 28px 30px; box-shadow:0 12px 30px rgba(0,0,0,0.08); }
    .catalog{ color:#444; font-variant: small-caps; letter-spacing: 0.05em; border-bottom:1px dotted var(--rule); padding-bottom:10px; margin-bottom:16px; display:flex; justify-content:space-between; align-items:baseline; gap:10px; }
    .catalog .mono{ font-family: var(--mono); color:#333; font-size:14px; }
    article{ font-family: var(--serif); font-size:18px; line-height:1.7; }
    article p{ text-indent:1.5em; margin:0 0 12px; }
    article p:first-of-type{ text-indent:0; }
    article p:first-of-type::first-letter{ float:left; font-size:3.1em; line-height:0.95; padding:4px 6px 0 2px; color:#3a2a0a; font-weight:700; }
    .frontis{ float:right; max-width:240px; margin:0 0 10px 16px; opacity:0.95; }
    @media (max-width: 720px){ .frontis{ display:none; } }
    .legend{ margin-top:10px; color:var(--muted); font-size:14px; }
    .colophon{ text-align:right; margin:-4px 0 10px; font-family: var(--mono); letter-spacing:1.5px; color:#6f5b43; opacity:0.85; }
    .footer{ color:#777; font-size:13px; margin-top:16px; }
    .epilogue{ display:none; margin-top:14px; padding:14px 16px; border:1px solid var(--rule); border-radius:12px; background:linear-gradient(180deg,#fff9e9,#fff4d8); box-shadow:0 6px 16px rgba(0,0,0,0.06); }
    .epilogue h3{ margin:0 0 6px; font-family: var(--serif); }
    .mono{ font-family: var(--mono); }
    .answer-ok{ outline:2px solid #3aa55d; outline-offset:2px; }
    .answer-bad{ outline:2px solid #b64242; outline-offset:2px; }
  </style>
</head>
<body>
  <header>
    <h1>The Library of Babel</h1>
    <div class="subtitle">Jorge Luis Borges imagined an infinite library...</div>
    <div class="controls">
      <label>Book ID:
        <input id="seedInput" type="number" value="12345" />
      </label>
      <button id="renderBtn">Retrieve Book From Stacks</button>
      <button id="randomBtn">Random Story</button>
<!--       <label>Answer:
        <input id="answerInput" type="text" placeholder="enter answer" />
      </label>
      <button id="checkBtn">Check Answer</button>
 -->      <span class="hint">Tip: use ← / → to step seeds; you can also set <code>?seed=12345</code> in the URL.</span>
    </div>
  </header>

  <main>
    <div id="sheet" class="paper">
      <div class="catalog">
        <div>§ I–V</div>
        <div class="mono" id="catalogStr"></div>
      </div>

      <figure class="frontis" aria-hidden="true">
        <!-- Inline SVG: library stacks illustration -->
        <svg viewBox="0 0 260 180" width="240" height="166" role="img" aria-label="Library stacks">
          <defs>
            <linearGradient id="wood" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0" stop-color="#9b7a51"/><stop offset="1" stop-color="#7e6040"/>
            </linearGradient>
            <linearGradient id="page" x1="0" x2="1">
              <stop offset="0" stop-color="#fffdf8"/><stop offset="1" stop-color="#f1e7d7"/>
            </linearGradient>
            <filter id="soft" x="-10%" y="-10%" width="120%" height="120%">
              <feDropShadow dx="0" dy="1" stdDeviation="1.2" flood-color="#000" flood-opacity="0.12"/>
            </filter>
          </defs>
          <rect x="8" y="10" width="8" height="160" fill="url(#wood)" rx="2"/><rect x="244" y="10" width="8" height="160" fill="url(#wood)" rx="2"/>
          <g fill="url(#wood)"><rect x="8" y="40" width="244" height="6" rx="2"/><rect x="8" y="92" width="244" height="6" rx="2"/><rect x="8" y="144" width="244" height="6" rx="2"/></g>
          <g filter="url(#soft)">
            <g>
              <rect x="20" y="14" width="14" height="26" fill="#b97d6d"/><rect x="36" y="16" width="10" height="24" fill="#7a95a6"/><rect x="48" y="18" width="18" height="22" fill="#d3b47f"/><rect x="68" y="12" width="12" height="28" fill="#6f8b6f"/><rect x="82" y="17" width="10" height="23" fill="#b07fa5"/><rect x="94" y="14" width="12" height="26" fill="#9f6b4f"/><rect x="108" y="20" width="16" height="20" fill="#7d6b9f"/><rect x="126" y="12" width="8" height="28" fill="#c0a27a"/><rect x="136" y="16" width="22" height="24" fill="#6e8fa0"/><rect x="160" y="18" width="10" height="22" fill="#a88d7a"/><rect x="172" y="14" width="12" height="26" fill="#8aa38b"/><rect x="186" y="19" width="14" height="21" fill="#c08b7e"/><rect x="202" y="13" width="9" height="27" fill="#9aa6b2"/><rect x="213" y="16" width="16" height="24" fill="#b8a07a"/><rect x="231" y="15" width="11" height="25" fill="#78907a"/>
            </g>
            <g>
              <rect x="22" y="66" width="12" height="24" fill="#7f97a8"/><rect x="36" y="60" width="16" height="30" fill="#caa77a"/><rect x="54" y="64" width="10" height="26" fill="#8a6f9b"/><rect x="66" y="58" width="14" height="32" fill="#6c8e76"/><rect x="82" y="62" width="18" height="28" fill="#a37f6b"/><rect x="102" y="66" width="12" height="24" fill="#9aa7b6"/><rect x="116" y="60" width="9" height="30" fill="#b98b7b"/><rect x="127" y="63" width="15" height="27" fill="#6e8aa0"/><rect x="144" y="62" width="12" height="28" fill="#a58d7a"/><rect x="158" y="66" width="10" height="24" fill="#8f9f8b"/><rect x="170" y="58" width="20" height="32" fill="#c29082"/><rect x="192" y="65" width="9" height="25" fill="#9aa6b2"/><rect x="203" y="62" width="17" height="28" fill="#b6a07b"/><rect x="222" y="64" width="12" height="26" fill="#6f8f7c"/>
            </g>
            <g>
              <rect x="20" y="118" width="14" height="24" fill="#a6907c"/><rect x="36" y="112" width="10" height="30" fill="#7b96a5"/><rect x="48" y="116" width="18" height="26" fill="#c8a67a"/><rect x="68" y="110" width="12" height="32" fill="#6e8d72"/><rect x="82" y="115" width="10" height="27" fill="#a27fa0"/><rect x="94" y="118" width="12" height="24" fill="#9e6b50"/><rect x="108" y="114" width="16" height="28" fill="#7d6b9f"/><rect x="126" y="110" width="8" height="32" fill="#c0a27a"/><rect x="136" y="116" width="22" height="26" fill="#6e8fa0"/><rect x="160" y="118" width="10" height="24" fill="#a88d7a"/><rect x="172" y="112" width="12" height="30" fill="#8aa38b"/><rect x="186" y="117" width="14" height="25" fill="#c08b7e"/><rect x="202" y="111" width="9" height="31" fill="#9aa6b2"/><rect x="213" y="115" width="16" height="27" fill="#b8a07a"/><rect x="231" y="116" width="11" height="26" fill="#78907a"/>
            </g>
          </g>
        </svg>
      </figure>

      <article id="story"></article>

      <div class="legend tiny">Roman numerals should be joined <em>aut exclusivum</em></div>
      <div id="epilogue" class="epilogue">
        <h3>Concordance Confirmed</h3>
        <p>In the dim stacks you discover a point that contains all points: a bright mote beneath the stair, indifferent to scale, inexhaustible. Your edition closes itself.</p>
      </div>
      <div class="footer tiny"></div>
    </div>
  </main>

<script>
const seedInput = document.getElementById('seedInput');
const renderBtn = document.getElementById('renderBtn');
const randomBtn = document.getElementById('randomBtn');
const answerInput = document.getElementById('answerInput');
const checkBtn = document.getElementById('checkBtn');
const epilogue = document.getElementById('epilogue');

function showEpilogue(){ epilogue.style.display='block'; epilogue.scrollIntoView({behavior:'smooth', block:'nearest'}); }

async function fetchAndRender(seed){
  const r = await fetch(`/api/story?seed=${seed>>>0}`);
  const data = await r.json();
  document.getElementById('story').innerHTML = data.html;
  document.getElementById('catalogStr').textContent = data.catalog;
}

async function checkAnswer(guess){
  try{
    const r = await fetch('/api/check', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ guess })
    });
    const data = await r.json();
    return !!data.ok;
  }catch(_){ return false; }
}

renderBtn.addEventListener('click', ()=>{
  const seed = Number(seedInput.value)||0;
  const url = new URL(window.location.href); url.searchParams.set('seed', String(seed>>>0));
  history.replaceState(null, '', url); fetchAndRender(seed);
});
randomBtn.addEventListener('click', ()=>{
  const seed = (Math.random()*0xffffffff)>>>0;
  seedInput.value = seed;
  const url = new URL(window.location.href); url.searchParams.set('seed', String(seed));
  history.replaceState(null, '', url); fetchAndRender(seed);
});
document.addEventListener('keydown', (e)=>{
  const tag = (e.target && e.target.tagName || '').toLowerCase();
  if(tag==='input' || tag==='textarea' || (e.target && e.target.isContentEditable)) return;
  if(e.key==='ArrowLeft' || e.key==='ArrowRight'){
    e.preventDefault();
    const delta = e.key==='ArrowLeft' ? -1 : 1;
    let seed = (Number(seedInput.value)||0) + delta; seed >>>= 0;
    seedInput.value = String(seed);
    const url = new URL(window.location.href); url.searchParams.set('seed', String(seed));
    history.replaceState(null, '', url); fetchAndRender(seed);
  }
});

// Answer checker (server-side)
checkBtn.addEventListener('click', async ()=>{
  const guess = answerInput.value || '';
  const ok = await checkAnswer(guess);
  answerInput.classList.remove('answer-ok','answer-bad');
  answerInput.classList.add(ok? 'answer-ok':'answer-bad');
  if(ok) showEpilogue();
});
answerInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); checkBtn.click(); } });

// Initial load
(function init(){
  const url = new URL(window.location.href);
  const s = url.searchParams.get('seed'); if(s!==null) seedInput.value = s;
  const a = url.searchParams.get('answer'); if(a){ answerInput.value=a; checkBtn.click(); }
  fetchAndRender(Number(seedInput.value)||0);
})();
</script>
</body>
</html>
