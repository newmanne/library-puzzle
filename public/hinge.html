<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hinge â€” Puzzle Hunt Prototype</title>
<style>
  :root {
    --bg: #0f172a;        /* slate-900 */
    --card: #ffffff;
    --ink: #0b1020;
    --muted: #6b7280;
    --accent: #0ea5e9;
    --line: #e5e7eb;
    --pill: #f4f5f7;
    --like: #ef4444;
    --nope: #6b7280;
  }
  html, body { margin:0; padding:0; background:var(--bg); color:#fff; font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, Noto Color Emoji, "Apple Color Emoji", Emoji; }
  .app { min-height:100dvh; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; padding:24px 12px; }
  .screen { width:min(720px, 92vw); }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .card {
    background:var(--card); color:var(--ink);
    border:1px solid var(--line); border-radius:16px;
    box-shadow: 0 10px 30px rgba(0,0,0,.18);
    overflow:hidden;
  }
  .card .hdr { display:flex; align-items:center; gap:10px; padding:16px 16px 8px; }
  .pill { background:var(--pill); border-radius:999px; padding:6px 10px; display:inline-flex; align-items:center; gap:6px; }
  /* Hinge-style prompts */
  .prompts { display:grid; gap:10px; }
  .prompt { background:#fff; border:1px solid var(--line); border-radius:14px; padding:10px 12px; }
  .prompt .q { font-size:12px; letter-spacing:.02em; text-transform:uppercase; color:var(--muted); margin-bottom:6px; }
  .prompt .a { font-size:15px; }
  /* CMY highlight indexing */
  .hl { padding:0 4px; border-radius:4px; font-weight:600; }
  .hl.c { background:#a5f3fc; color:#0e7490; }
  .hl.m { background:#fbcfe8; color:#9d174d; }
  .hl.y { background:#fde68a; color:#92400e; }
  .hl.g { background:#bbf7d0; color:#065f46; }
  .hl.p { background:#ddd6fe; color:#5b21b6; }
  .hl.k { background:#e5e7eb; color:#374151; }
  /* tiny chess board */
  .mini-board { display:grid; grid-template-columns: repeat(5, 28px); gap:4px; margin-top:6px; }
  .mini-board .sq { width:28px; height:28px; border:1px solid var(--line); border-radius:6px; display:grid; place-items:center; font-weight:700; font-size:14px; background:#f8fafc; color:#111827; position:relative; }
  .mini-board .sq.dim { color:#9ca3af; font-weight:500; }
  .mini-board .sq.start::after { content:'â™'; position:absolute; top: -9px; left:-2px; font-size:12px; }
  .avatar { width:48px; height:48px; border-radius:50%; background:var(--pill); display:grid; place-items:center; font-size:26px; }
  .meta { color:var(--muted); font-size:14px; }
  .photos { display:flex; gap:8px; padding:8px 16px 0; }
  .tile { background:var(--pill); border:1px solid var(--line); width:92px; height:92px; border-radius:12px; display:grid; place-items:center; font-size:30px; position:relative; }
  .tile small { position:absolute; right:6px; bottom:6px; color:#374151; font-size:10px; opacity:.75; }
  /* Photo + skeleton */
  .photo-wrap { position:relative; height:220px; background:#e5e7eb; overflow:hidden; border-top-left-radius:16px; border-top-right-radius:16px; }
  .photo { width:100%; height:100%; object-fit:cover; object-position:center top; display:block; }
  .photo-wrap.contain .photo { object-fit:contain; background:#e5e7eb; }
  .photo-wrap.skeleton .photo { visibility:hidden; }
  .photo-wrap.skeleton::after {
    content:''; position:absolute; inset:0; transform:translateX(-100%);
    background:linear-gradient(90deg, rgba(229,231,235,0) 0%, rgba(229,231,235,0) 20%, rgba(255,255,255,0.7) 50%, rgba(229,231,235,0) 80%, rgba(229,231,235,0) 100%);
    animation: shimmer 1.2s infinite;
  }
  @keyframes shimmer { 100% { transform:translateX(100%);} }
  .body { padding:8px 16px 16px; }
  .section { font-weight:700; margin-top:8px; margin-bottom:6px; }
  .muted { color:var(--muted); }
  .hr { height:1px; background:var(--line); margin:8px 0; }
  .ctr { text-align:center; }
  .actions { display:flex; gap:12px; padding:12px 0 4px; justify-content:center; }
  button, .btn {
    border:1px solid var(--line); background:#fff; color:var(--ink);
    padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer;
    transition:.15s transform ease, .15s box-shadow ease, .15s background ease;
  }
  button:hover { transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.1); }
  .btn-like { background:#fff; border-color:#fecaca; color:var(--like); }
  .btn-nope { background:#fff; color:#374151; }
  .btn-ghost { background:#0ea5e9; border-color:#0ea5e9; color:white; }
  .toolbar { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  /* toolbar elements */
  /* progress removed */
  .pill { color: var(--ink); }
  .note { background:#0b1220; border:1px dashed #334155; color:#cbd5e1; padding:10px 12px; border-radius:10px; }
  .bad { color:#fca5a5; }
  .good { color:#86efac; }
  .kbd { font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; background:#f3f4f6; padding:1px 6px; border-radius:6px; border:1px solid #e5e7eb; }
  /* modal */
  .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); padding:20px; }
  .modal.show { display:flex; }
  .dialog { background:#ffffff; color:var(--ink); border-radius:16px; max-width:520px; width:min(520px,92vw); border:1px solid var(--line); box-shadow:0 20px 40px rgba(0,0,0,.35); }
  .dialog .head { padding:14px 16px; border-bottom:1px solid var(--line); font-weight:700; }
  .dialog .content { padding:14px 16px; display:grid; gap:10px; }
  .dialog .foot { padding:14px 16px; border-top:1px solid var(--line); display:flex; justify-content:flex-end; gap:10px; }
  input[type=text] { width:100%; box-sizing:border-box; padding:12px 12px; border-radius:10px; border:1px solid #e5e7eb; font-size:16px; }
  /* subtle success state when message is correct */
  .input-ok { background:#ecfdf5 !important; border-color:#86efac !important; box-shadow:0 0 0 4px rgba(16,185,129,.15) inset; }
  .small { font-size:12px; }
  .linkish { color:#93c5fd; text-decoration:underline; cursor:pointer; }
  .hidden { display:none !important; }
</style>
</head>
<body>
<div class="app">
  <div class="screen" id="screen-select">
    <div class="card">
      <div class="hdr">
        <div class="avatar">ğŸ§ </div>
        <div>
          <div style="font-weight:800;font-size:18px">Choose Your Character</div>
          <!-- <div class="meta">Who are you?</div> -->
        </div>
      </div>
      <div class="body">
        <div class="row" id="starter-row"></div>
        <div class="hr"></div>
        <div class="note small">
        </div>
      </div>
    </div>
  </div>

  <div class="screen hidden" id="screen-play">
    <div class="toolbar">
      <div class="pill">You as: <span id="persona-pill"></span></div>
      <button id="btn-reset" class="btn">Reset</button>
    </div>
    <div id="deck"></div>
  </div>

  <div class="screen hidden" id="screen-outcome">
    <div class="card" id="outcome-card">
      <div class="hdr">
        <div class="avatar">ğŸ“‹</div>
        <div>
          <div style="font-weight:800;font-size:18px">Summary</div>
          <div class="meta">How your swipes stacked up.</div>
        </div>
      </div>
      <div class="body">
        <div id="outcome-html"></div>
        <div class="actions">
          <button class="btn" id="btn-again">Try again?</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Right-swipe -> message modal -->
<div class="modal" id="modal">
  <div class="dialog">
    <div class="head">Send a message</div>
    <div class="content">
      <input type="text" id="msg" placeholder="Type your openerâ€¦" />
    </div>
    <div class="foot">
      <button class="btn btn-nope" id="btn-cancel">Cancel</button>
      <button class="btn btn-like" id="btn-send">Send</button>
    </div>
  </div>
</div>

<script>
/*** DATA ***************************************************************/

// TODO: Too many penguin books. (Use https://www.penguin.co.uk/penguin-classics/classics-list)

// 3 YOU personas: each wants a specific subset of the 10 via a tag.
const PERSONAS = [
  {
    id: 'penguin',
    name: 'Avery', age: 29, role: 'Editor', loc: 'Mount Pleasant',
    avatar: 'ğŸ§',
    photo: 'img/hinge/persona-penguin.png',
    blurb: "I really, really love penguins ğŸ§",
    prompts: [
      { q: 'My love language is', a: 'Mogran Freeman impressions.' },
      { q: 'Weâ€™ll get along if', a: 'You let me call you emporer and king.' },
      { q: 'Unusual skill', a: 'Looking great in a tux.' },
    ],
    targetTag: 'penguin',
    unlock: {
      name: 'Ivy', avatar: 'ğŸ“˜', role: 'Vancouver Acquarium', loc: 'Kits',
      photo: 'img/hinge/unlock-penguin.png',
      prompts: [
        { q: 'Fun fact', a: 'Contrary to many popular holiday cartoons, youâ€™ll never see penguins and polar bears together in the wild.' },
        { q: 'Fun fact', a: `(Yes, same prompt twice, sue me). The black and white â€œtuxedoâ€ look donned by most penguin species is a clever camouflage called countershading.` },
        { q: `I'll bet you can't guess`, a: 'My favourite animal.' },
      ],
      prize: "Let's go for a date at Kits Beach!"
    }
  },
  {
    id: 'ghost',
    name: 'Mo', age: 31, role: 'Archivist', loc: 'Grandview',
    avatar: 'ğŸ‘»',
    photo: 'img/hinge/persona-ghost.png',
    blurb: "Into ghosts ğŸ‘»",
    prompts: [
      { q: 'A fact about me that surprises people', a: 'I believe the dead can still impact the world.' },
      { q: 'I go crazy for', a: 'Ectoplast.' },
      { q: 'Green flag', a: 'You live in a haunted house.' },
    ],
    targetTag: 'posthumous',
    unlock: {
      name: 'Casper', avatar: 'ğŸ“œ', role: 'Estate lawyer', loc: 'Downtown',
      photo: 'img/hinge/unlock-ghost.png',
      prompts: [
        { q: 'Case file', a: 'Probate signed, acknowledgments read.' },
        { q: 'Note', a: 'You chose the right word.' }
      ],
      prize: "Are you free in 1931?"
    }
  },
  {
    id: 'xlat',
    name: 'Ling', age: 30, role: 'Subtitler', loc: 'Strathcona',
    avatar: 'ğŸŒ',
    photo: 'img/hinge/persona-xlat.png',
    blurb: "Talk to me in many languages ğŸŒ",
    prompts: [
      { q: 'Iâ€™m known for', a: 'Arguing with translators in the margins.' },
      { q: 'A life goal of mine', a: 'Read every book twiceâ€”in two languages.' },
      { q: 'Quickest way to my heart', a: 'A sexy foreign accent.' },
    ],
    targetTag: 'translated',
    unlock: {
      name: 'Sasha', avatar: 'ğŸ—ºï¸', role: 'Rights manager', loc: 'West End',
      photo: 'img/hinge/unlock-xlat.png',
      prompts: [
        { q: 'Rights sheet', a: 'Original language cleared.' },
        { q: 'Note', a: 'You nailed the title I had in mind.' }
      ],
      prize: "Que faites-vous le 15 aoÃ»t?"
    }
  },
];

// 10 puzzle profiles â†’ each yields a book title; tagged for personas.
const POOL = [
  {
    id:'p1', name:'Sam', age:28, role:'Marine biologist', loc:'Vancouver', avatar:'ğŸ£',
    photo:'img/hinge/p1.png',
    photos:['ğŸŒŠ','ğŸŸ','ğŸª¸'],
    prompts: [ // TODO: The word search sucks and the puzzle might be broken 
      { q: 'Sometimes my life feels like', a: `
        <div class="kbd" style="display:block;white-space:pre;line-height:1.2em;">
K E H U B T R
M E N Q Q A L
C L L G Y T S
O W Q P V K E
D F T E R N A
W A V E S O B
G U M L F H O
        </div>` },
      { q: 'Currently reading', a: 'Mobyâ€‘Dick (becauseâ€¦ whales).'},
      { q: 'Fun fact', a: 'In my day to day I collect kelp, eel, ray, cod, tern, and just generally the sea. And sometimes more fun leftovers are in the mix!' }
    ],
    tags:['penguin'] 
  },
  {
    id:'p2', name:'Leo', age:33, role:'Night shooter', loc:'West End', avatar:'ğŸŒ‰',
    photo:'img/hinge/p2.png',
    photos:['ğŸŒƒ','ğŸ“·','ğŸŒ‰'],
    prompts: [
      { q: 'My hobbies', a: `ğŸ ğŸ  ğŸŠ ğŸ™ ğŸŒ³ Â· ğŸª€ ğŸ«’ â˜‚ï¸ ğŸš€ Â· ğŸ¿ â™¥ï¸ ğŸ¦¦ ğŸš†` },
      { q: 'Blue hour ritual', a: 'Shoot, stroll, then bookstore. Last pick: The Trial.' },
      { q: 'Iâ€™m convinced', a: 'Night coffee tastes better.' }
    ],
    tags:['posthumous','translated','penguin']
  },
  {
    id:'p3', name:'Elle', age:29, role:'UX researcher', loc:'Downtown', avatar:'âŒ¨ï¸',
    photo:'img/hinge/p3.png',
    photos:['â™','âŒ¨ï¸','ğŸ§©'],
    prompts: [
      { q: `You'll impress me if you can`, a: `Make a 
        <div class="mini-board">
          <div class="sq start">N</div><div class="sq dim">Â·</div><div class="sq">C</div><div class="sq dim">Â·</div><div class="sq dim">Â·</div>
          <div class="sq dim">Â·</div><div class="sq dim">Â·</div><div class="sq dim">Â·</div><div class="sq dim">Â·</div><div class="sq">E</div>
          <div class="sq dim">Â·</div><div class="sq">I</div><div class="sq">V</div><div class="sq dim">Â·</div><div class="sq dim">Â·</div>
          <div class="sq dim">Â·</div><div class="sq dim">Â·</div><div class="sq dim">Â·</div><div class="sq">M</div><div class="sq">E</div>
          <div class="sq dim">Â·</div><div class="sq">O</div><div class="sq dim">Â·</div><div class="sq dim">Â·</div><div class="sq dim">Â·</div>
        </div>
      ` },
      { q: `Let's debate this topic`, a: `What is the best opener?` },
      { q: 'Currently reading', a: 'Invisible Cities (for the UX of imagination).' }
    ],
    tags:['penguin','translated']
  },
  {
    id:'p4', name:'Marie', age:31, role:'Editor at CMY Industries', loc:'Coal Harbour', avatar:'ğŸ”¤',
    photo:'img/hinge/p4.png',
    photos:['ğŸ–¨ï¸','ğŸ¨','ğŸ“š'],
    prompts: [
      { q: `I'm most proud of`, a: `My job. It isn't always as easy as 123, but there are so many oppourtunities to add value.`},
      { q: 'The highlights of dating me', a: `
        <span class="hl c">title</span>
        <span class="hl m">audit</span>
        <span class="hl y">correct</span>
        <span class="hl g">kern</span>
        <span class="hl c">topline</span>
        <span class="hl m">chisel</span>
        <span class="hl k">stroke</span>
        <span class="hl p">sharp</span>
        <span class="hl c">author</span>
        <span class="hl g">program</span>
        <span class="hl y">scene</span>
      ` },
      { q: 'Bookshelf', a: 'Pride and Prejudice'}
    ],
    tags:['penguin']
  },
  {
    id:'p5', name:'Gavin', age:30, role:'Transit ops', loc:'Fairview', avatar:'ğŸ“±',
    photo:'img/hinge/p14.png',
    photos:['ğŸšŒ','ğŸ•’','ğŸ“±'],
    prompts: [
      { q: 'Two truths and a lie (Select the number)', a: `1) I'm very sporty
      2) I'm really into astronomy
      3) I have a dog` },
      { q: 'Love language', a: 'Accurate bus ETAs' },
      { q: 'Commute read', a: 'The Little Prince (pocket edition).'}
    ],
    tags:['penguin','translated', 'posthumous']
  },
  {
    id:'p6', name:'Cora', age:27, role:'Chef', loc:'North Shore', avatar:'ğŸ³',
    photo:'img/hinge/p6.png',
    photos:['ğŸ³','ğŸ¥˜','ğŸ§‚'],
    prompts: [
      { q: 'My favourite recipe', a: `<ul>
        <li>Mince 3 cloves garlic into a bowl.</li>
        <li>Whisk in 15 mL olive oil with lemon.</li>
        <li>Let it sit 15 minutes to mellow.</li>
        <li>Season with 11 g sea salt.</li>
        <li>Fold in 23 g toasted walnuts.</li>
        <li>Add 9 cherry tomatoes, halved.</li>
        <li>Stir in 20 g tahini.</li>
        <li>Tear 8 basil leaves.</li>
        <li>Finish with 13 g mint, chopped.</li>
        <li>Rest 5 minutes; serve.</li>
      </ul>` },
      { q: 'Cookbook crush', a: 'Kitchen (Banana Yoshimoto).' },
      { q: 'Green flag', a: 'You bring lemons without being asked.' }
    ],
    tags:['penguin','translated']
  },
  {
    id:'p7', name:'Skipper', age:34, role:'Ferry fan', loc:'â€”', avatar:'â›µ',
    photo:'img/hinge/p7.png',
    photos:['â›´ï¸','ğŸŒŠ','ğŸŸ'],
    prompts: [
      { q: 'Me in my element', a: `The Colonelâ€™s buckets & the Gombe researcher <br/>
Canadian mac-and-cheese mottos & a prairie contralto <br/>
Rice-cereal onomatopoeia & a Spurs coach <br/>
The crown-wearing burger chain motto & The Great One` },
      { q: 'Are you also weird like me?', a: 'When a sandwich has an odd number of slices of meat, I think the top half tastes better. But when it has an even number of slices, I prefer the bottom.'},
      { q: 'Perfect Sunday', a: 'Ferries, fries, and a paperback. Currently reading A Confederacy of Dunces (laugh-out-loud ferry read).' }
    ],
    tags:['posthumous']
  },
  {
    id:'p8', name:'Wren', age:28, role:'Arborist', loc:'Fairview', avatar:'ğŸŒ³',
    photo:'img/hinge/p8.png',
    photos:['ğŸŒ³','ğŸ‚','ğŸªµ'],
    prompts: [
      { q: 'These are a few of my favourite things', a: `Taxus, Vitis, Arbutus, Acer, Cupressus, Pseudotsuga, Tsuga, Betula, Alnus, Picea, Quercus, â€¦` },
      { q: 'Together we could', a: 'Go for a stroll and see what comes next.' },
      { q: 'Typeshelf', a: 'Frankenstein (loves a good reprint saga).'},
    ],
    tags:['penguin']
  },
  {
    id:'p9', name:'Robin', age:32, role:'Analyst', loc:'Financial District', avatar:'ğŸ“ˆ',
    photo:'img/hinge/p9.png',
    photos:['ğŸ“ˆ','ğŸ“°','ğŸ’¼'],
    prompts: [
      { q: 'Ticker picks', a: `Terex, Tencent Music Entertainment, Loews, Aterian` },
      { q: 'Desk read', a: 'The Three-Body Problem.' },
      { q: 'Hot take', a: 'Buy and hold beats dayâ€‘trading.' }
    ],
    tags:['penguin','translated'] 
  },
  {
    id:'p10', name:'Kat', age:30, role:'Barista', loc:'Mount Pleasant', avatar:'â˜•',
    photo:'img/hinge/p10.png',
    photos:['â˜•','ğŸ“š','âœ¨'],
    prompts: [
      { q: `I bet I can guess your order`, a: `Mocha, Earl Grey, Espresso, Tea? Flat white, Oolong, Ristretto? Cortado, Oat latte, Filter, FrappÃ©, Espressino?` },
      { q: 'Weâ€™ll get along if', a: 'You like lateâ€‘night pages and early cappuccinos.' },
      { q: 'Currently reading', a: 'The Master and Margarita (after hours).'}
    ],
    tags:['posthumous','translated','penguin']
  },
  {
    id:'p11', name:'Riley', age:26, role:'Cheer captain', loc:'UBC', avatar:'ğŸ“£',
    photo:'img/hinge/p12.png',
    photos:['ğŸ“£','ğŸ’ƒ','ğŸ’‹'],
    prompts: [
      { q: `We'll get along if`, a: `You also have a dirty mind ğŸ˜‰. Suggest a hot place we could cuddle? ğŸ”¥` },
      { q: 'My ideal first date', a: `First, you work your jaw up and down (9) [1][2] <br/>
Then, I dress up in a cute sailor outfit and bring out a tool for us to navigate some new positions (7) [6][7] <br/>
Next, you let me call you daddy (a title that you'll hold in name only, of course.) (7) [5] <br/>
Lastly, you tease me with punishment codes (5) [2] 
` },
      { q: 'Dating me is most like the book', a: 'Hard Times (Charles ğŸ†ens)' }
    ],
    tags:['penguin']
  },
];

// Utility for easy, consistent matching (strip non-letters/numbers, upcase)
const normalize = s => (s||'').toUpperCase().replace(/[^A-Z0-9]/g,'');

/*** STATE **************************************************************/
const state = {
  persona: null,
  order: [],          // randomized order of the 10
  idx: 0,             // index in order
  ledger: [],         // per-profile decisions
  
  selectIdx: 0,       // starter carousel index
  lastMsg: {},        // remembers last message per pid (including FINAL:persona)
};

/*** RENDER HELPERS *****************************************************/

const $ = sel => document.querySelector(sel);
function el(tag, attrs={}, ...kids){
  const n = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k==='class') n.className=v;
    else if (k==='html') n.innerHTML=v;
    else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.substring(2), v);
    else n.setAttribute(k,v);
  }
  for (const k of kids) n.append(k);
  return n;
}

function renderStarterCard(p){
  const c = el('div',{class:'card', style:'flex:1 1 220px; min-width:220px;'});
  c.append(
    el('div',{class:'hdr'},
      el('div',{class:'avatar'}, p.avatar),
      el('div',{},
        el('div',{html:`<b>${p.name}, ${p.age}</b>`}),
        el('div',{class:'meta', html:`${p.role} â€¢ ${p.loc}`})
      )
    ),
    // hero photo (image if present, else SVG placeholder) â€” contain fit for full view
    renderPhoto(p.photo, `${p.name}'s photo`, svgPlaceholder(p.name, p.avatar), 'contain'),
    el('div',{class:'body'},
      (p.prompts && p.prompts.length)
        ? el('div',{class:'prompts'},
            ...p.prompts.map(pa => el('div',{class:'prompt'},
              el('div',{class:'q'}, pa.q),
              el('div',{class:'a', html: pa.a})
            ))
          )
        : el('div',{class:'prompts'},
            el('div',{class:'prompt'},
              el('div',{class:'q'}, 'About me'),
              el('div',{class:'a', html:p.blurb})
            )
          ),
      
      el('div',{class:'actions'},
        el('button',{class:'btn btn-ghost', onclick:()=>choosePersona(p.id)},'Be this person')
      )
    )
  );
  return c;
}

function renderProfileCard(p){
  const card = el('div',{class:'card'});
  const fav = (p.tags||[]).join(' â€¢ ');
  card.append(
    el('div',{class:'hdr'},
      el('div',{class:'avatar'}, p.avatar),
      el('div',{},
        el('div',{html:`<b>${p.name}, ${p.age}</b>`}),
        el('div',{class:'meta', html:`${p.role} â€¢ ${p.loc}`})
      )
    ),
    renderPhoto(p.photo, `${p.name}'s photo`, svgPlaceholder(p.name, p.avatar), 'contain'),
    el('div',{class:'body'},
      (p.prompts && p.prompts.length)
        ? el('div',{class:'prompts'},
            ...p.prompts.map(pa => el('div',{class:'prompt'},
              el('div',{class:'q'}, pa.q),
              el('div',{class:'a', html: pa.a})
            ))
          )
        : el('div',{})
    ),
    el('div',{class:'body'},
      el('div',{class:'actions'},
        el('button',{class:'btn btn-nope', onclick:()=>swipe(p,false)},'Swipe Left'),
        el('button',{class:'btn btn-like', onclick:()=>openMessage(p)},'Swipe Right')
      )
    )
  );
  return card;
}

function renderUnlockCard(persona, u){
  const card = el('div',{class:'card'});
  card.append(
    el('div',{class:'hdr'},
      el('div',{class:'avatar'}, u.avatar),
      el('div',{},
        el('div',{html:`<b>${u.name}</b>`}),
        el('div',{class:'meta', html:`${u.role} â€¢ ${u.loc}`})
      ),
      el('div',{style:'margin-left:auto; display:flex; gap:8px;'},
        el('span',{class:'pill'}, 'New here')
      )
    ),
    renderPhoto(u.photo, `${u.name}'s photo`, svgPlaceholder(u.name, u.avatar), 'contain'),
    el('div',{class:'body'},
      (u.prompts && u.prompts.length)
        ? el('div',{class:'prompts'},
            ...u.prompts.map(pa => el('div',{class:'prompt'},
              el('div',{class:'q'}, pa.q),
              el('div',{class:'a', html: pa.a})
            ))
          )
        : el('div',{})
    ),
    el('div',{class:'body'},
      el('div',{class:'actions'},
        el('button',{class:'btn btn-like', onclick:()=>openFinalMessage(persona)},'Send Message')
      )
    )
  );
  return card;
}

/*** FLOW ***************************************************************/

function init(){
  // starters
  state.selectIdx = 0;
  // load saved last messages
  try {
    const raw = localStorage.getItem('hinge:lastMsg');
    if (raw) state.lastMsg = JSON.parse(raw) || {};
  } catch {}
  renderStarterCarousel();
  // hotkeys removed
  // modal buttons
  $('#btn-cancel').onclick = closeModal;
  // unify send handling so FINAL messages don't fall through to regular send
  $('#btn-send').addEventListener('click', async (e)=>{
    const pid = $('#modal').dataset.pid || '';
    if (pid.startsWith('FINAL:')){
      const persona = state.persona;
      const msg = $('#msg').value || '';
      let ok = false;
      try {
        const r = await fetch('/api/hinge-check', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ pid, msg }) });
        const j = await r.json();
        ok = !!(j && j.ok && j.correct);
      } catch {}
      // remember last message for FINAL pid
      state.lastMsg[pid] = msg;
      try { localStorage.setItem('hinge:lastMsg', JSON.stringify(state.lastMsg)); } catch {}
      if (ok) { $('#msg').classList.add('input-ok'); await new Promise(r=>setTimeout(r, 420)); }
      closeModal();
      if (ok){
        // Fetch prize text from server and show match card
        let prizeHtml = '';
        try {
          const rp = await fetch('/api/hinge-unlock?persona='+encodeURIComponent(persona.id)+'&prize=1');
          const jp = await rp.json();
          if (jp && jp.ok && jp.unlock && jp.unlock.prize) prizeHtml = jp.unlock.prize;
        } catch {}
        const deck = $('#deck');
        deck.innerHTML = '';
        deck.append(
          el('div',{class:'card'},
            el('div',{class:'hdr'},
              el('div',{class:'avatar'}, 'ğŸ’Œ'),
              el('div',{}, el('div',{html:`<b>Itâ€™s a match!</b>`}),
                           el('div',{class:'meta', html:`You and your final suitor unlockedâ€¦`})
              )
            ),
            el('div',{class:'body'},
              prizeHtml ? el('div',{class:'note good', html: prizeHtml}) : el('div',{class:'note'},'Prize unlocked.'),
              el('div',{class:'hr'}),
              el('div',{class:'muted small'},'Collect all three date parts across the three YOU profiles.')
            ),
            el('div',{class:'body'},
              el('div',{class:'actions'},
                el('button',{class:'btn', onclick:()=>show('screen-select')},'Pick another YOU')
              )
            )
          )
        );
      } else {
        // final failed â†’ outcome â€œno matchâ€
        $('#outcome-html').innerHTML = `
          <div class="note bad"><b>Close, but no.</b> Your final message didnâ€™t land. Youâ€™ll need to retry this YOU.</div>
        `;
        show('screen-outcome');
      }
      e.stopImmediatePropagation();
      e.preventDefault();
      return;
    }
    // regular profile message
    await sendMessage();
  });
  $('#btn-reset').onclick = resetAll;
  $('#btn-again').onclick = ()=>{ show('screen-select'); };
  $('#btn-retry').onclick = ()=>{ choosePersona(state.persona.id); };
  // Enter-to-send in the message input
  const msgInput = document.getElementById('msg');
  if (msgInput){
    msgInput.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey){
        e.preventDefault();
        document.getElementById('btn-send').click();
      }
    });
  }
  show('screen-select');
}
function renderStarterCarousel(){
  const row = $('#starter-row');
  row.innerHTML='';
  const idx = ((state.selectIdx % PERSONAS.length) + PERSONAS.length) % PERSONAS.length;
  const p = PERSONAS[idx];
  row.append(
    el('div',{class:'row', style:'align-items:stretch; width:100%;'},
      el('button',{class:'btn', onclick:()=>{ state.selectIdx--; renderStarterCarousel(); }},'â€¹'),
      el('div',{style:'flex:1 1 auto; min-width:0;'}, renderStarterCard(p)),
      el('button',{class:'btn', onclick:()=>{ state.selectIdx++; renderStarterCarousel(); }},'â€º')
    )
  );
}
function show(id){
  for (const s of document.querySelectorAll('.screen')) s.classList.add('hidden');
  $('#'+id).classList.remove('hidden');
  if (id==='screen-select') renderStarterCarousel();
}
function isDebug(){
  return /(?:\?|&)debug=1(?:&|$)/.test(location.search);
}
function choosePersona(id){
  state.persona = PERSONAS.find(p=>p.id===id);
  state.order = shuffle([...POOL.map(p=>p.id)]);
  state.idx = 0;
  state.ledger = [];
  $('#persona-pill').textContent = `${state.persona.name} ${state.persona.avatar}`;
  show('screen-play');
  rerenderDeck();
}
function rerenderDeck(){
  const deck = $('#deck');
  deck.innerHTML = '';
  if (state.idx < state.order.length){
    const p = POOL.find(q=>q.id===state.order[state.idx]);
    deck.append(renderProfileCard(p));
  } else {
    // Evaluate correctness
    evaluate();
  }
  // progress removed
}
function swipe(profile, right){
  if (!right){
    state.ledger.push({id:profile.id, right:false, msg:null, ok:false});
    state.idx++;
    rerenderDeck();
  } else {
    openMessage(profile);
  }
}
function openMessage(profile){
  $('#modal').classList.add('show');
  const pid = profile.id;
  const input = $('#msg');
  input.classList.remove('input-ok');
  input.value = state.lastMsg[pid] || '';
  input.focus();
  $('#modal').dataset.pid = profile.id;
}
function closeModal(){ $('#modal').classList.remove('show'); }

async function sendMessage(){
  const pid = $('#modal').dataset.pid;
  const profile = POOL.find(p=>p.id===pid);
  const msg = $('#msg').value || '';
  let ok = false;
  try {
    const r = await fetch('/api/hinge-check', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ pid, msg }) });
    const j = await r.json();
    ok = !!(j && j.ok && j.correct);
  } catch {}
  // remember last message for this pid
  state.lastMsg[pid] = msg;
  try { localStorage.setItem('hinge:lastMsg', JSON.stringify(state.lastMsg)); } catch {}
  if (ok) { $('#msg').classList.add('input-ok'); await new Promise(r=>setTimeout(r, 420)); }
  state.ledger.push({id:pid, right:true, msg, ok});
  closeModal();
  state.idx++;
  rerenderDeck();
}

// Unlock final suitor flow
function evaluate(){
  const persona = state.persona;
  const wantTag = persona.targetTag;
  // Build expected set and actual hits
  const must = POOL.filter(p => (p.tags||[]).includes(wantTag)).map(p=>p.id);
  const didRight = state.ledger.filter(x=>x.right && x.ok).map(x=>x.id);
  const didWrongRights = state.ledger.filter(x=>x.right && !x.ok).map(x=>x.id);
  const extraRights = didRight.filter(id => !must.includes(id));
  const missed = must.filter(id => !didRight.includes(id));
  const anyWrong = didWrongRights.length>0 || extraRights.length>0 || missed.length>0;
  if (anyWrong){
    const debug = isDebug();
    if (debug){
      const bullet = arr => arr.map(id=>{
        const p = POOL.find(q=>q.id===id);
        return `<li>${p.name}</li>`;
      }).join('');
      $('#outcome-html').innerHTML = `
        <div class="note bad"><b>No match unlocked.</b></div>
        <div class="hr"></div>
        <div class="row">
          <div style="flex:1 1 240px; min-width:240px;">
            <div class="section">You missed (should have matched):</div>
            <ul>${bullet(missed) || '<li><i>None</i></li>'}</ul>
          </div>
          <div style="flex:1 1 240px; min-width:240px;">
            <div class="section">You matched but shouldnâ€™t have:</div>
            <ul>${bullet(extraRights) || '<li><i>None</i></li>'}</ul>
            <div class="section">Right-swipes with wrong messages:</div>
            <ul>${bullet(didWrongRights) || '<li><i>None</i></li>'}</ul>
          </div>
        </div>
      `;
    } else {
      $('#outcome-html').innerHTML = `
        <div class="note bad">Sorry, there's no more profiles to swipe through for today and you have no matches. But don't give up hope! The one is still waiting out there for you.</div>
      `;
    }
    show('screen-outcome');
  } else {
    // success â†’ show persona-specific 11th
    const deck = $('#deck');
    deck.innerHTML='';
    // success â†’ fetch persona-specific 11th from server
    loadUnlock(persona);
  }
}
async function loadUnlock(persona){
  const deck = $('#deck');
  deck.innerHTML='';
  try {
    const r = await fetch('/api/hinge-unlock?persona='+encodeURIComponent(persona.id));
    const j = await r.json();
    if (j && j.ok && j.unlock) {
      deck.append(renderUnlockCard(persona, j.unlock));
      return;
    }
  } catch {}
  // fallback minimal
  deck.append(renderUnlockCard(persona, {name:'New match', avatar:'ğŸ’Œ', role:'â€”', loc:'â€”', prompts:[]}));
}
function openFinalMessage(persona){
  $('#modal').classList.add('show');
  const pid = 'FINAL:'+persona.id;
  const input = $('#msg');
  input.classList.remove('input-ok');
  input.value = state.lastMsg[pid] || '';
  input.focus();
  $('#modal').dataset.pid = 'FINAL:'+persona.id;
}
function sendFinal(msg){
  // unused: we reuse sendMessage logic branch by pid prefix
}
// progress removed
function resetAll(){
  state.persona = null; state.order=[]; state.idx=0; state.ledger=[];
  show('screen-select');
}

/*** UTILS **************************************************************/
function shuffle(a){
  for (let i=a.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}
// Simple hash for color seeding and SVG/photo helpers
function hash(s){ let h=0; for (let i=0;i<s.length;i++) h=((h<<5)-h + s.charCodeAt(i))|0; return Math.abs(h); }
function svgPlaceholder(label, emoji){
  const palettes = [
    ['#fde68a','#f59e0b'], // amber
    ['#a7f3d0','#10b981'], // emerald
    ['#bfdbfe','#3b82f6'], // blue
    ['#fecaca','#ef4444'], // red
    ['#ddd6fe','#8b5cf6'], // violet
    ['#fbcfe8','#ec4899'], // pink
  ];
  const [c1,c2] = palettes[hash(label)%palettes.length];
  const w=900, h=600;
  const title = (label||'').split(' ')[0];
  const initial = title.slice(0,1).toUpperCase();
  const svg = `
  <svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}' viewBox='0 0 ${w} ${h}'>
    <defs>
      <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
        <stop offset='0%' stop-color='${c1}'/>
        <stop offset='100%' stop-color='${c2}'/>
      </linearGradient>
      <filter id='grain'>
        <feTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='2' stitchTiles='stitch'/>
        <feColorMatrix type='saturate' values='0'/>
        <feComponentTransfer>
          <feFuncA type='table' tableValues='0 0.15'/>
        </feComponentTransfer>
      </filter>
    </defs>
    <rect width='100%' height='100%' fill='url(#g)'/>
    <rect width='100%' height='100%' filter='url(#grain)' opacity='0.07'/>
    <g text-anchor='middle' dominant-baseline='middle'>
      <text x='50%' y='44%' font-size='200' fill='rgba(255,255,255,0.9)'>${emoji||initial}</text>
      <text x='50%' y='72%' font-size='64' fill='rgba(255,255,255,0.9)' font-family='system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial'>${title}</text>
    </g>
  </svg>`;
  return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
}
function renderPhoto(primarySrc, alt, placeholderSrc, fit){
  const wrap = el('div',{class:'photo-wrap skeleton' + (fit==='contain' ? ' contain' : '')});
  const img = el('img',{class:'photo', alt:alt||'', loading:'lazy'});
  img.src = primarySrc || placeholderSrc;
  img.addEventListener('load', ()=>{ wrap.classList.remove('skeleton'); });
  img.addEventListener('error', ()=>{
    if (img.src !== placeholderSrc) {
      img.src = placeholderSrc;
    }
    wrap.classList.remove('skeleton');
  });
  wrap.append(img);
  return wrap;
}
// Init after DOM is ready to ensure starter selection shows first
(function(){
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
</body>
</html>
