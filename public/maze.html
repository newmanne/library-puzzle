<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Restricted Stacks — Vigenère Build (Maze)</title>
  <style>
    :root{
      --bg:#0c0f12;           /* deep library midnight */
      --panel:#12161b;        /* terminal well */
      --ink:#e6edf3;          /* readable text */
      --muted:#9aa7b2;        /* secondary */
      --accent:#caa46b;       /* brass plaque */
      --link:#8fb0ff;         /* subtle blue */
    }
    html,body{height:100%;}
    body{
      margin:0; background:linear-gradient(180deg, #0c0f12 0%, #0e1116 60%, #0c0f12 100%);
      color:var(--ink); font:16px/1.5 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      display:flex; flex-direction:column; align-items:center; justify-content:stretch;
    }
    header{max-width:1020px; width:100%; padding:20px 16px 8px; box-sizing:border-box;}
    h1{margin:0 0 4px; font-size:20px; font-weight:700; letter-spacing:0.5px;}
    .subtitle{color:var(--muted); font-size:13px}

    .terminal{ max-width:1020px; width:100%; flex:1; display:flex; flex-direction:column; box-sizing:border-box;
      background:var(--panel); border:1px solid #1d232b; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35);
      overflow:hidden; margin:8px 16px 16px; }
    #view{ padding:18px; overflow:auto; white-space:pre-wrap; word-break:break-word; flex:1; scroll-behavior:smooth; }
    #view::-webkit-scrollbar{width:10px;height:10px}
    #view::-webkit-scrollbar-thumb{background:#222b35;border-radius:10px}

    .line{margin:0 0 4px;}
    .line .prompt{color:#7bc275}
    .line .muted{color:var(--muted)}
    .line .accent{color:var(--accent)}
    .exits{color:var(--link)}

    form#cmdbar{display:flex; gap:10px; border-top:1px solid #1d232b; padding:12px 14px; align-items:center; background:rgba(255,255,255,0.02)}
    #promptGlyph{color:#7bc275}
    #cmd{ flex:1; background:#0e1318; color:var(--ink); border:1px solid #1b2129; border-radius:8px; padding:10px 12px;
      outline:none; font:15px/1.2 ui-monospace, monospace; box-shadow:inset 0 0 0 1px rgba(0,0,0,.25); }
    #cmd::placeholder{color:#61707f}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{background:#0e1318; color:var(--ink); border:1px solid #1b2129; border-radius:8px; padding:8px 10px; cursor:pointer; font:13px ui-monospace, monospace}
    .btn:hover{border-color:#293444}
    .btn:active{transform:translateY(1px)}

    .footer{max-width:1020px; width:100%; padding:0 16px 18px; color:var(--muted); font-size:12px; box-sizing:border-box}

    @media (max-width:640px){ body{font-size:15px;} }
  </style>
</head>
<body>
  <header>
    <h1>📚 Lost in The Stacks</h1>
    <div class="subtitle">A thrilling text adventure!</div>
  </header>

  <div class="terminal" role="region" aria-label="Adventure terminal">
    <div id="view" aria-live="polite" aria-atomic="false"></div>
    <form id="cmdbar" autocomplete="off">
      <span id="promptGlyph" aria-hidden="true">&gt;</span>
      <input id="cmd" name="cmd" placeholder="Enter a command (e.g., n; e; look; pull book)" autofocus />
      <div class="toolbar">
        <button type="button" class="btn" id="btnHelp" title="Help">help</button>
        <button type="button" class="btn" id="btnLook" title="Look">look</button>
        <button type="button" class="btn" id="btnSettings" aria-expanded="false" title="Settings">⚙︎</button>
      </div>
    </form>
  </div>
  <div class="footer">

  <dialog id="settingsDialog">
    <form method="dialog" style="min-width: min(640px, 90vw); background:#0e1318; color:var(--ink); border:1px solid #1b2129; border-radius:12px; padding:16px;">
      <h3 style="margin:0 0 8px">Settings</h3>
      <div style="display:grid; grid-template-columns: auto 1fr; gap:8px 12px; align-items:center; font:14px ui-monospace, monospace;">
        <label for="speed">Typing speed (ms/char)</label>
        <input id="speed" type="number" min="0" step="1" value="2" style="background:#0c1116;color:var(--ink);border:1px solid #1b2129;border-radius:8px;padding:6px 8px;">
        <label>Instant text</label>
        <input id="instantToggle" type="checkbox">
        <label>High contrast</label>
        <input id="contrastToggle" type="checkbox">
        <label>Show debug</label>
        <input id="debugToggle" type="checkbox">
        <label>Last response only</label>
        <input id="lastOnlyToggle" type="checkbox" checked>
        <label>Reveal maze map on look (debug)</label>
        <input id="revealMapToggle" type="checkbox">
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
        <button class="btn" value="cancel">Close</button>
      </div>
    </form>
  </dialog>

  <script>
  /********************
   * Utility & PRNG   *
   ********************/
  function hashStringToInt(str){ let h = 2166136261 >>> 0; for (let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); } return h >>> 0; }
  function mulberry32(a){ return function(){ a |= 0; a = a + 0x6D2B79F5 | 0; let t = Math.imul(a ^ a >>> 15, 1 | a); t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t; return ((t ^ t >>> 14) >>> 0) / 4294967296; }; }
  function pick(rng, arr){ return arr[Math.floor(rng()*arr.length)] }
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));

  /********************
   * Dimensions & Params *
   ********************/
  // Dimensions handled server-side
  const urlParams = new URLSearchParams(location.search);
  const runSelfTestsParam = urlParams.get('selftest') === '1';

  
  /********************
   * Maze graph handled server-side
   ********************/


  let visitTitle = null; // per-visit cache of last title shown

  /********************
   * Room description *
   ********************/
  async function roomDescriptor(x,y){
    const params = new URLSearchParams({ x:String(x), y:String(y) });
    try{
      params.set('op','room');
      const r = await fetch('/api/maze?'+params.toString());
      const data = await r.json();
      lastRoom = data || null;
      const lines = (data && data.lines) || ['You are somewhere in the stacks.'];
      const exitsLine = (data && data.exitsLine) || 'Exits: (unknown).';
      return { lines, exitsLine, features: {ukColour:false, ukCatalogue:false, badPlural:false, hyphenEndcap:false, enDash:false}, sig: null };
    }catch(_){
      const lines = ['You are somewhere in the stacks.'];
      const exitsLine = 'Exits: (unknown).';
      return { lines, exitsLine, features: {ukColour:false, ukCatalogue:false, badPlural:false, hyphenEndcap:false, enDash:false}, sig: null };
    }
  }

  /********************
   * Engine & I/O      *
   ********************/
  const view = document.getElementById('view');
  const cmdInput = document.getElementById('cmd');
  const btnHelp = document.getElementById('btnHelp');
  const btnLook = document.getElementById('btnLook');
  const btnSettings = document.getElementById('btnSettings');
  const settingsDialog = document.getElementById('settingsDialog');
  const speedInput = document.getElementById('speed');
  const instantToggle = document.getElementById('instantToggle');
  const contrastToggle = document.getElementById('contrastToggle');
  const debugToggle = document.getElementById('debugToggle');
  const lastOnlyToggle = document.getElementById('lastOnlyToggle');
  const revealMapToggle = document.getElementById('revealMapToggle');

  let typing=false, skipCurrent=false, typeSpeed=Number(speedInput.value);
  document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && typing){ skipCurrent=true; } });
  speedInput.addEventListener('change', ()=>{ typeSpeed = Math.max(0, Number(speedInput.value)||0); });
  btnSettings.addEventListener('click', ()=> settingsDialog.showModal());
  btnHelp.addEventListener('click', ()=> issue('help'));
  btnLook.addEventListener('click', ()=> issue('look'));
  lastOnlyToggle.addEventListener('change', ()=>{ view.style.overflow = lastOnlyToggle.checked? 'hidden':'auto'; });
  if (lastOnlyToggle.checked) { view.style.overflow = 'hidden'; }

  const queue=[]; function print(text, cls){ queue.push({text,cls}); if(!typing) processQueue(); }
  function processQueue(){ if(queue.length===0){ typing=false; return; } typing=true; const {text,cls}=queue.shift(); const div=document.createElement('div'); div.className='line'+(cls?' '+cls:''); view.appendChild(div); typewrite(div,text,()=>{ view.scrollTop=view.scrollHeight; processQueue(); }); }
  function typewrite(el, text, done){ if (instantToggle.checked || typeSpeed===0){ el.textContent=text; done(); return; } skipCurrent=false; el.textContent=''; let i=0; const tick=()=>{ if(skipCurrent){ el.textContent=text; done(); return; } el.textContent += text[i++]; if(i<text.length){ setTimeout(tick, typeSpeed);} else { done(); } }; setTimeout(tick, typeSpeed); }
  function echoCommand(cmd){ print('> '+cmd, 'prompt'); }
  function clearForLastOnly(){ if(!lastOnlyToggle.checked) return; queue.length=0; typing=false; view.innerHTML=''; }

  function issue(cmd, suppressEcho=false, done){
    if(lastOnlyToggle.checked){ clearForLastOnly(); }
    if(!suppressEcho) echoCommand(cmd);
    parse(cmd);
    if(typeof done==='function') done();
  }

  /********************
   * Game State        *
   ********************/
  const state = {
    x: 0, y: 0, steps:0,
    hasCard:false,
    inVault:false, hasSecretBook:false, secretOpen:false
  };
  function hereKey(){ return `${state.x},${state.y}` }

  /********************
   * Map rendering (server)
   ********************/
  async function printMaze(){
    try{
      const params = new URLSearchParams({ x:String(state.x), y:String(state.y), signals:'1' });
      params.set('op','map');
      const r = await fetch('/api/maze?'+params.toString());
      const data = await r.json();
      const lines = (data && data.lines) || [];
      lines.forEach(s=>print(s));
    }catch(e){ print('Error: Failed to load map.'); console.error(e); }
  }

  /********************
   * Core actions      *
   ********************/
  async function look(){
    const d = await roomDescriptor(state.x, state.y);
    d.lines.forEach(t=>print(t));
    print(d.exitsLine, 'exits');
    if(revealMapToggle.checked){ print(''); await printMaze(); }
    const ex = (lastRoom && Array.isArray(lastRoom.exits) ? lastRoom.exits.join('') : '');
    if (debugToggle.checked){ const sigMark = (lastRoom && lastRoom.isSignal)? '*' : '-'; print(`[debug] coords=${state.x},${state.y} sig=${sigMark} exits=${ex}`, 'muted'); }
  }

  async function move(dir){
    try{
      const params = new URLSearchParams({ x:String(state.x), y:String(state.y), dir:String(dir||'').toLowerCase(), steps:String(state.steps), secretOpen:String(!!state.secretOpen), inVault:String(!!state.inVault) });
      params.set('op','step');
      const r = await fetch('/api/maze?'+params.toString());
      const data = await r.json();
      clearForLastOnly();
      if(data && data.ok){
        if(data.blocked){ print('Towering shelves block your way.'); return; }
        if(data.teleported && data.reason === 'chute'){
          print('Whee! You fly through the return chute and land elsewhere.');
        }
        state.x = data.x|0; state.y = data.y|0; state.inVault = !!data.inVault; state.steps++;
        visitTitle = null; await look();
      } else {
        print('Error: Movement failed.');
      }
    }catch(e){ print('Error: Movement request failed.'); console.error(e); }
  }

  function openThing(what){ clearForLastOnly(); if(!what){ print('Open what?'); return; } if((lastRoom && lastRoom.flags && lastRoom.flags.lost) && /(drawer|lost|found|counter)/.test(what)){ print('You slide the shallow drawer open. Inside lies a scuffed library card.'); return; } print("It doesn't seem to open."); }
  function takeThing(what){
    clearForLastOnly();
    if(!what){ print('Take what?'); return;}
    if((lastRoom && lastRoom.flags && lastRoom.flags.lost) && /(card|library card)/.test(what)){
      if(state.hasCard){ print('You already pocketed the card.'); }
      else { state.hasCard=true; print('Taken: a scuffed library card warm from your palm.'); }
      return;
    }
    if((lastRoom && lastRoom.flags && lastRoom.flags.secretBook) && /(book|secret passage)/i.test(what)){
      if(state.hasSecretBook){ print('You already have the slim volume.'); }
      else { state.hasSecretBook=true; print('Taken: "The Secret Passage". The cover smells faintly of paste.'); }
      return;
    }
    print("You can't take that.");
}
  async function readThing(obj){
    clearForLastOnly();
    obj=(obj||'').toLowerCase();
    if(/^(card|library card)$/.test(obj)){
      if(!state.hasCard){ print('You do not seem to have a card.'); return; }
    try{
      const r = await fetch('/api/maze?op=card');
      const data = await r.json();
      const c = (data && data.card) || { title:'LIBRARY CARD', issuer:'', barcode:''};
      print(c.title || 'LIBRARY CARD');
        print('  Patron: You');
        if(c.barcode) print('  Barcode: ' + c.barcode);
      }catch(e){
        print('Error: Failed to load card.'); console.error(e);
      }
      return;
    }
    if((/^(primer|chalkboard|slate|math|mathematics|board)$/).test(obj) && lastRoom && lastRoom.flags && lastRoom.flags.math){
      try{
        const params = new URLSearchParams({ x:String(state.x), y:String(state.y), action:'primer' });
        params.set('op','action');
        const r = await fetch('/api/maze?'+params.toString());
        const data = await r.json();
        if(data && data.ok && Array.isArray(data.lines)) data.lines.forEach(t=>print(t)); else print('Nothing useful here.');
      }catch(e){ print('Error: Failed to read primer.'); console.error(e); }
      return;
    }
    if((/^(plaque|sign|note|instructions)$/).test(obj) && lastRoom && lastRoom.flags && lastRoom.flags.vault){
      print('The plaque reads:');
      print('  "When you have deciphered the library\'s whisper, speak it here: say <WORD>."');
      return;
    }
    
    print('Nothing to read.'); }

  function sitHere(){
    clearForLastOnly();
    if(!(lastRoom && lastRoom.flags && lastRoom.flags.reading)){
      print("There's nowhere comfortable to sit.");
      return;
    }
    print('You settle into the comfy chair. A slim volume slides into your lap:');
    print('  "A Treatise on Using Binary to Represent Letters"');
    print('You read: "You can represent a letter using five binary bits. Weight each 1,2,4,8,16 and sum → A=1…Z=26."');
  }


  

  function normalizeCmd(arg){ const a=(arg||'').trim().toLowerCase(); if(a==='on'){ state.normalized=true; } else if(a==='off'){ state.normalized=false; } else { state.normalized=!state.normalized; } clearForLastOnly(); print('Normalization ' + (state.normalized?'on.':'off.')); look(); }

  async function pullBook(){
    clearForLastOnly();
    // Disallow pulling in special rooms
    const f = (lastRoom && lastRoom.flags) || {};
    const isSpecial = !!(f.lost || f.math || f.reading || f.vault || f.chute || f.unity || f.secretShelf || f.secretAnnex || f.secretBook);
    if(isSpecial){ print('You do not find any pullable books here.'); return; }
    // If we've already pulled a book in this room visit, reuse it
    if(visitTitle){
      const isSig = !!(lastRoom && lastRoom.isSignal);
      if(isSig){
        print('You slide out a slim volume. Its gilt title reads:');
      } else {
        print('You pull a cracked volume from the shelf. Its title reads:');
      }
      print(`  "${visitTitle}."`);
      print('You replace it carefully.');
      return;
    }
    try{
      const params = new URLSearchParams({ x:String(state.x), y:String(state.y) });
      params.set('op','pull');
      const r = await fetch('/api/maze?'+params.toString());
      const data = await r.json();
      if(!(data && data.ok)){
        print('You do not find any pullable books here.');
        return;
      }
      const title = (data && data.title) || 'Untitled Monograph';
      const isSig = !!(data && data.isSignal);
      if(isSig){
        print('You slide out a slim volume. Its gilt title reads:');
      } else {
        print('You pull a cracked volume from the shelf. Its title reads:');
      }
      print(`  "${title}."`);
      print('You replace it carefully.');
      visitTitle = title;
    }catch(e){ print('Error: Failed to pull book.'); console.error(e); }
  }



  async function sayWord(raw){
    clearForLastOnly();
    if(!(lastRoom && lastRoom.flags && lastRoom.flags.vault)){ print('Your whisper is swallowed by the stacks.'); return; }
    const spoken = (raw||'').trim(); if(!spoken){ print('Say what?'); return; }
    try{
      const r = await fetch('/api/maze?op=check', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ word: spoken }) });
      const data = await r.json();
      if(data && data.ok){
        print('The door warms beneath your hand and swings inward. A codex on a lectern lies open to the answer you sought.');
        print('You are blinded by light as the library fades away and you find yourself outside. Go call Neil.');
        state.inVault = true;
      } else {
        print('The vault remains cold. The word is not quite right.');
      }
    }catch(e){ print('Error: Vault check failed.'); console.error(e); }
  }




  function placeBook(){
    clearForLastOnly();
    if(!state.hasSecretBook){ print('You have nothing that seems to fit any gap.'); return; }
    if(!(lastRoom && lastRoom.flags && lastRoom.flags.secretShelf)){ print('There\'s no obvious place to put that here.'); return; }
    if(state.secretOpen){ print('The shelf already stands ajar.'); return; }
    const dir = 'e'; // direction revealed in server description
    state.secretOpen=true;
    print('You slide "The Secret Passage" into the waiting gap. With a soft click, the shelving pivots open to the '+{n:'north',e:'east',s:'south',w:'west'}[dir]+'.');
  } 

  function help(){ clearForLastOnly();
    print('Commands:');
    print('  n/e/s/w — move');
    print('  look — re-describe this aisle');
    print('  pull book — grab a book from the library shelf');
    print('  sit — in the reading room, study a treatise');
    print('  reset — reset the adventure');
  }

  function parse(cmd){ cmd = (cmd||'').trim(); if(!cmd) return; const raw=cmd; cmd=cmd.toLowerCase();
    if(['n','north'].includes(cmd)) return move('n');
    if(['e','east'].includes(cmd)) return move('e');
    if(['s','south'].includes(cmd)) return move('s');
    if(['w','west'].includes(cmd)) return move('w');
    if(['l','look','examine','x'].includes(cmd)) return look();
    if(cmd==='help'||cmd==='?') return help();
    if(cmd==='settings'){ settingsDialog.showModal(); return; }
    
    if(cmd==='maze'){ clearForLastOnly(); printMaze(); return; }
    if(cmd==='selftest'){ clearForLastOnly(); runSelfTests(); return; }
    
    if(cmd==='quit'||cmd==='restart'||cmd==='reset'){ view.innerHTML=''; visitTitle=null; lastRoom=null; state.x=0; state.y=0; state.steps=0; state.hasCard=false; state.normalized=false; state.inVault=false; state.hasSecretBook=false; state.secretOpen=false; intro(); return; }

    if(cmd.startsWith('open ')) return openThing(raw.slice(5));
    if(cmd.startsWith('take ')) return takeThing(raw.slice(5));
    if(cmd.startsWith('read ')) return readThing(raw.slice(5));
    if(cmd==='sit') return sitHere();
    
    
    if(cmd==='pull book' || cmd==='pull' || cmd==='browse' || cmd==='check shelf' || cmd==='inspect book' || cmd==='take book') return pullBook();
    
    if(cmd.startsWith('say ')) return sayWord(raw.slice(4));
    if(cmd==='put book' || cmd==='insert book' || cmd==='place book' || cmd==='use book' || cmd==='return book') return placeBook();

    

    clearForLastOnly();
    print(`I don't understand "${cmd}".`);
    print('Try: help');
  }

  function intro(){
    clearForLastOnly();
    print('You slipped past the roped barrier into the Restricted Stacks.');
    look();
  }

  /********************
   * Self-tests (dev)  *
   ********************/
  function runSelfTests(){
    const results=[]; const ok=(cond,msg)=>{ results.push((cond?'✅':'❌')+' '+msg); };
    try { ok(typeof issue==='function', 'issue() is defined'); } catch(e){ ok(false, 'issue() throws'); }
    try { issue('look', true); ok(true, 'can call issue("look")'); } catch(e){ ok(false, 'issue("look") failed: '+e); }
    print('Self-tests:', 'muted'); results.forEach(r=>print('  '+r, 'muted'));
  }

  // Boot (robust)
  async function boot(){
    try{
      // Server mode: no ciphertext/signals loaded on client
      intro();
      if(runSelfTestsParam){ runSelfTests(); }
      const form = document.getElementById('cmdbar');
      if(form){
        form.addEventListener('submit', (e)=>{ e.preventDefault(); const val=cmdInput.value; cmdInput.value=''; issue(val); });
      }
      const obs = new MutationObserver(()=>{ if(view){ view.scrollTop = view.scrollHeight; } });
      if(view){ obs.observe(view, {childList:true}); }
    }catch(e){
      const fallback = document.getElementById('view') || document.body;
      const div = document.createElement('div');
      div.className='line muted';
      div.textContent = 'Startup error: ' + (e && e.message ? e.message : e);
      fallback.appendChild(div);
      console.error(e);
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
  </script>
</body>
</html>
